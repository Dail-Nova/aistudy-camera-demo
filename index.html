<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ã‚¢ã‚¤ã‚¹ã‚¿ ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
      background: #000;
    }
    
    .screen {
      display: none;
      width: 100vw;
      height: 100vh;
      height: 100dvh; /* å‹•çš„ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ */
      flex-direction: column;
    }
    
    .screen.active {
      display: flex;
    }
    
    /* ã‚«ãƒ¡ãƒ©ç”»é¢ */
    #camera-screen {
      background: #000;
      position: relative;
    }
    
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: transparent;
      padding: 15px;
      color: #fff;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      text-shadow: 0 2px 8px rgba(0,0,0,0.8);
    }
    
    #camera-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
    }
    
    .camera-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: auto;
      background: transparent;
      padding: 30px 20px;
      text-align: center;
      z-index: 100;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 15px;
    }
    
    .hint {
      color: #fff;
      font-size: 12px;
      margin-bottom: 15px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8); /* è¦–èªæ€§å‘ä¸Š */
      background: rgba(0,0,0,0.6); /* ãƒ’ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆã«èƒŒæ™¯ */
      padding: 8px 12px;
      border-radius: 4px;
    }
    
    #shutter-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #fff;
      border: 4px solid #333;
      cursor: pointer;
      transition: transform 0.1s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5); /* å½±ã§æµ®ãä¸ŠãŒã‚‰ã›ã‚‹ */
    }
    
    #shutter-btn:active {
      transform: scale(0.95);
    }
    
    /* ç·¨é›†ç”»é¢ */
    #preview-screen {
      background: #222;
    }
    
    .preview-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    #preview-canvas {
      max-width: 100%;
      max-height: 100%;
      touch-action: none;
    }
    
    .edit-controls {
      flex-shrink: 0;
      background: #1a1a1a;
      padding: 20px;
    }
    
    .control-group {
      margin-bottom: 20px;
    }
    
    .control-label {
      color: #fff;
      font-size: 14px;
      margin-bottom: 8px;
      display: block;
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #brightness-slider {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #444;
      outline: none;
      -webkit-appearance: none;
    }
    
    #brightness-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
    }
    
    #brightness-value {
      color: #fff;
      font-size: 14px;
      min-width: 40px;
      text-align: right;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .btn:active {
      opacity: 0.7;
    }
    
    .btn-secondary {
      background: #444;
      color: #fff;
    }
    
    .btn-primary {
      background: #06c755;
      color: #fff;
      font-weight: bold;
    }
    
    /* å‡¦ç†ä¸­ç”»é¢ */
    #processing-screen {
      background: #fff;
      align-items: center;
      justify-content: center;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #f0f0f0;
      border-top-color: #06c755;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .processing-text {
      font-size: 16px;
      color: #333;
      margin-bottom: 10px;
    }
    
    .processing-hint {
      font-size: 12px;
      color: #999;
    }
    
    /* å®Œäº†ç”»é¢ */
    #complete-screen {
      background: #fff;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }
    
    .complete-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    
    .complete-message {
      font-size: 14px;
      color: #666;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .action-btn {
      width: 200px;
      padding: 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    
    .action-btn-primary {
      background: #06c755;
      color: #fff;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    /* ã‚¨ãƒ©ãƒ¼ç”»é¢ */
    #error-screen {
      background: #fff;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }
    
    .error-title {
      font-size: 24px;
      font-weight: bold;
      color: #e74c3c;
      margin-bottom: 10px;
    }
    
    .error-detail {
      font-size: 14px;
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      padding: 0 20px;
    }
  </style>
</head>
<body>

  <!-- ã‚«ãƒ¡ãƒ©ç”»é¢ -->
  <div id="camera-screen" class="screen">
    <div class="header">ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³</div>
    <video id="camera-preview" autoplay playsinline></video>
    <div class="camera-controls">
      <div class="hint">ã‚¢ã‚¤ã‚¹ã‚¿ã«èããŸã„ç®‡æ‰€ã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚</div>
      <button id="shutter-btn"></button>
    </div>
  </div>

  <!-- ç·¨é›†ç”»é¢ -->
  <div id="preview-screen" class="screen">
    <div class="header">ç·¨é›†</div>
    <div class="preview-container">
      <canvas id="preview-canvas"></canvas>
    </div>
    <div class="edit-controls">
      <div class="control-group">
        <label class="control-label">æ˜ã‚‹ã•</label>
        <div class="slider-container">
          <input type="range" id="brightness-slider" min="50" max="150" value="100">
          <span id="brightness-value">100%</span>
        </div>
      </div>
      <div class="button-group">
        <button class="btn btn-secondary" id="rotate-btn">ğŸ”„ å›è»¢</button>
        <button class="btn btn-secondary" id="retake-btn">ğŸ“· æ’®ã‚Šç›´ã—</button>
      </div>
      <button class="btn btn-primary" id="send-btn">âœ… ã“ã®å†…å®¹ã§é€ä¿¡</button>
    </div>
  </div>

  <!-- å‡¦ç†ä¸­ç”»é¢ -->
  <div id="processing-screen" class="screen">
    <div class="spinner"></div>
    <div class="processing-text">æ–‡å­—èµ·ã“ã—ä¸­...</div>
    <div class="processing-hint">20ã€œ40ç§’ã»ã©ãŠå¾…ã¡ãã ã•ã„</div>
  </div>

  <!-- å®Œäº†ç”»é¢ -->
  <div id="complete-screen" class="screen">
    <div class="complete-title">å‡¦ç†å®Œäº†</div>
    <div class="complete-message">
      æ–‡å­—èµ·ã“ã—çµæœã‚’LINEã§é€ä¿¡ã—ã¾ã—ãŸã€‚<br>
      ãƒˆãƒ¼ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
    </div>
    <button class="action-btn action-btn-primary" id="new-scan-btn">æ–°ã—ãã‚¹ã‚­ãƒ£ãƒ³</button>
  </div>

  <!-- ã‚¨ãƒ©ãƒ¼ç”»é¢ -->
  <div id="error-screen" class="screen">
    <div class="error-title" id="error-title">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>
    <div class="error-detail" id="error-detail"></div>
    <button class="action-btn action-btn-primary" id="retry-btn">ã‚‚ã†ä¸€åº¦è©¦ã™</button>
  </div>

  <script>
    // ========================================
    // è¨­å®š
    // ========================================
    const LIFF_ID = '2008304828-OnEyAwBm';
    const WORKER_URL = 'https://aista-document-processor.luminalice-reg-tea-sun-red-9b0.workers.dev/upload-image';
    const DEBUG_MODE = true;

    // ========================================
    // çŠ¶æ…‹ç®¡ç†
    // ========================================
    let userId = null;
    let displayName = null;
    let cameraStream = null;
    let originalCanvas = null;
    let cropArea = null;
    let rotation = 0;
    let brightness = 1.0;
    let isDragging = false;
    let dragTarget = null;
    let dragStartX = 0;
    let dragStartY = 0;
    let cameraInitialized = false;
    let cameraPermissionState = 'unchecked'; // 'unchecked' | 'granted' | 'denied'

    // ========================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ========================================
    function debugLog(message) {
      if (DEBUG_MODE) {
        const timestamp = new Date().toLocaleTimeString('ja-JP');
        console.log(`[${timestamp}] ${message}`);
      }
    }

    function showScreen(screenId) {
      debugLog(`ç”»é¢é·ç§»: ${screenId}`);
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function showError(title, detail) {
      debugLog(`ã‚¨ãƒ©ãƒ¼è¡¨ç¤º: ${title} - ${detail}`);
      document.getElementById('error-title').textContent = title;
      document.getElementById('error-detail').textContent = detail;
      showScreen('error-screen');
    }

    // ========================================
    // STEP 2: LIFFåˆæœŸåŒ–
    // ========================================
    async function initLiff() {
      try {
        debugLog('LIFFåˆæœŸåŒ–é–‹å§‹...');
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          debugLog('æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ');
          liff.login();
          return false;
        }
        
        const profile = await liff.getProfile();
        userId = profile.userId;
        displayName = profile.displayName;
        debugLog(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—: ${displayName} (${userId})`);
        
        return true;
      } catch (error) {
        debugLog(`âŒ LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        showError('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', 'LINEã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
        return false;
      }
    }

    // ========================================
    // STEP 3: ã‚«ãƒ¡ãƒ©èµ·å‹•
    // ========================================
    async function checkCameraPermission() {
      // Permissions APIã§äº‹å‰ç¢ºèª
      if (navigator.permissions && navigator.permissions.query) {
        try {
          const result = await navigator.permissions.query({ name: 'camera' });
          debugLog(`ã‚«ãƒ¡ãƒ©æ¨©é™çŠ¶æ…‹: ${result.state}`);
          
          if (result.state === 'granted') {
            return 'granted';
          } else if (result.state === 'denied') {
            return 'denied';
          }
          return 'unchecked';
        } catch (e) {
          debugLog('Permissions APIéå¯¾å¿œ');
          return 'unchecked';
        }
      }
      return 'unchecked';
    }

    async function initCamera() {
      // æ—¢ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒã‚ã‚‹å ´åˆã¯å†åˆ©ç”¨
      if (cameraStream && cameraInitialized) {
        debugLog('ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ å†åˆ©ç”¨');
        const video = document.getElementById('camera-preview');
        video.srcObject = cameraStream;
        return;
      }
      
      // æ‹’å¦çŠ¶æ…‹ã®å ´åˆã¯æ¡ˆå†…ç”»é¢ã®ã¿
      if (cameraPermissionState === 'denied') {
        debugLog('ã‚«ãƒ¡ãƒ©æ‹’å¦æ¸ˆã¿ - æ¡ˆå†…è¡¨ç¤º');
        showCameraPermissionGuide();
        return;
      }
      
      // äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼ˆåˆå› or ãƒªãƒˆãƒ©ã‚¤æ™‚ï¼‰
      if (cameraPermissionState === 'unchecked') {
        const preCheckState = await checkCameraPermission();
        if (preCheckState === 'denied') {
          cameraPermissionState = 'denied';
          showCameraPermissionGuide();
          return;
        }
      }
      
      try {
        debugLog('ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–é–‹å§‹...');
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });
        
        cameraStream = stream;
        cameraPermissionState = 'granted';
        cameraInitialized = true;
        
        const video = document.getElementById('camera-preview');
        video.srcObject = stream;
        
        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        video.addEventListener('loadedmetadata', () => {
          debugLog(`Video size: ${video.videoWidth}x${video.videoHeight}`);
          const controls = document.querySelector('.camera-controls');
          const rect = controls.getBoundingClientRect();
          debugLog(`Controls position: top=${rect.top}, bottom=${rect.bottom}`);
          debugLog(`Controls visible: ${rect.bottom <= window.innerHeight}`);
        }, { once: true });
        
        debugLog('âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ');
      } catch (error) {
        handleCameraError(error);
      }
    }

    function handleCameraError(error) {
      debugLog(`ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${error.name} - ${error.message}`);
      
      if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
        // æ‹’å¦ã•ã‚ŒãŸ
        cameraPermissionState = 'denied';
        showCameraPermissionGuide();
        
      } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
        // ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚‰ãªã„
        showError(
          'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
          'ãŠä½¿ã„ã®ç«¯æœ«ã«ã¯ã‚«ãƒ¡ãƒ©ãŒæ­è¼‰ã•ã‚Œã¦ã„ãªã„ã‹ã€æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'
        );
        
      } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
        // ã‚«ãƒ¡ãƒ©ãŒä»–ã®ã‚¢ãƒ—ãƒªã§ä½¿ç”¨ä¸­
        showError(
          'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“',
          'ä»–ã®ã‚¢ãƒ—ãƒªãŒã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\nä»–ã®ã‚¢ãƒ—ãƒªã‚’çµ‚äº†ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
        );
        
      } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
        // è¦æ±‚ã•ã‚ŒãŸæ¡ä»¶ã‚’æº€ãŸã›ãªã„
        debugLog('ã‚«ãƒ¡ãƒ©æ¡ä»¶ã‚’ç·©å’Œã—ã¦å†è©¦è¡Œ...');
        retryWithLowerConstraints();
        
      } else {
        // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
        showError('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼', error.message);
      }
    }

    async function retryWithLowerConstraints() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true // æœ€å°é™ã®è¨­å®š
        });
        cameraStream = stream;
        cameraPermissionState = 'granted';
        cameraInitialized = true;
        document.getElementById('camera-preview').srcObject = stream;
        debugLog('âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸï¼ˆä½ç”»è³ªãƒ¢ãƒ¼ãƒ‰ï¼‰');
      } catch (error) {
        showError('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼', 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
    }

    function showCameraPermissionGuide() {
      const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
      const isAndroid = /Android/.test(navigator.userAgent);
      
      let instructions = '';
      if (isIOS) {
        instructions = 'ã€iOSè¨­å®šæ–¹æ³•ã€‘\n\n' +
          '1. iPhoneã®ã€Œè¨­å®šã€ã‚’é–‹ã\n' +
          '2. ã€ŒLINEã€ã‚’é¸æŠ\n' +
          '3. ã€Œã‚«ãƒ¡ãƒ©ã€ã‚’ONã«ã™ã‚‹\n' +
          '4. LINEã‚¢ãƒ—ãƒªã«æˆ»ã‚‹\n' +
          '5. ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™';
      } else if (isAndroid) {
        instructions = 'ã€Androidè¨­å®šæ–¹æ³•ã€‘\n\n' +
          '1. ã€Œè¨­å®šã€ã‚’é–‹ã\n' +
          '2. ã€Œã‚¢ãƒ—ãƒªã€â†’ã€ŒLINEã€ã‚’é¸æŠ\n' +
          '3. ã€Œæ¨©é™ã€â†’ã€Œã‚«ãƒ¡ãƒ©ã€ã‚’é¸æŠ\n' +
          '4. ã€Œè¨±å¯ã€ã‚’é¸æŠ\n' +
          '5. LINEã‚¢ãƒ—ãƒªã«æˆ»ã‚‹\n' +
          '6. ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™';
      } else {
        instructions = 'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
      }
      
      showError(
        'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨è¨±å¯ãŒå¿…è¦ã§ã™',
        instructions
      );
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        cameraInitialized = false;
        debugLog('ã‚«ãƒ¡ãƒ©åœæ­¢');
      }
    }

    // ========================================
    // STEP 4: æ’®å½±
    // ========================================
    function capturePhoto() {
      try {
        debugLog('æ’®å½±é–‹å§‹...');
        const video = document.getElementById('camera-preview');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        originalCanvas = canvas;
        debugLog(`âœ… æ’®å½±å®Œäº† (${canvas.width}x${canvas.height})`);
        
        // ãƒ‡ãƒã‚¤ã‚¹ã®ã‚¢ãƒ«ãƒãƒ ã«ä¿å­˜
        saveToDevice(canvas);
        
        // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯åœæ­¢ã—ãªã„ï¼ˆå†åˆ©ç”¨ã®ãŸã‚ï¼‰
        showPreview();
      } catch (error) {
        debugLog(`âŒ æ’®å½±ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        showError('æ’®å½±ã‚¨ãƒ©ãƒ¼', 'ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }
    
    function saveToDevice(canvas) {
      try {
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `aista_scan_${Date.now()}.jpg`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          debugLog('ç”»åƒã‚’ãƒ‡ãƒã‚¤ã‚¹ã«ä¿å­˜');
        }, 'image/jpeg', 0.95);
      } catch (error) {
        debugLog(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        // ä¿å­˜å¤±æ•—ã—ã¦ã‚‚å‡¦ç†ã¯ç¶™ç¶š
      }
    }

    // ========================================
    // STEP 5: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    // ========================================
    function showPreview() {
      showScreen('preview-screen');
      
      const previewCanvas = document.getElementById('preview-canvas');
      const maxWidth = window.innerWidth;
      const maxHeight = window.innerHeight * 0.5;
      
      const scale = Math.min(
        maxWidth / originalCanvas.width,
        maxHeight / originalCanvas.height
      );
      
      previewCanvas.width = originalCanvas.width * scale;
      previewCanvas.height = originalCanvas.height * scale;
      
      // ãƒˆãƒªãƒŸãƒ³ã‚°æ åˆæœŸåŒ–
      cropArea = {
        x: previewCanvas.width * 0.1,
        y: previewCanvas.height * 0.1,
        width: previewCanvas.width * 0.8,
        height: previewCanvas.height * 0.8
      };
      
      rotation = 0;
      brightness = 1.0;
      
      redrawPreview();
      debugLog('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºå®Œäº†');
    }

    // ========================================
    // STEP 6-7: ç”»åƒç·¨é›†ï¼ˆæ˜ã‚‹ã•ãƒ»å›è»¢ï¼‰
    // ========================================
    function redrawPreview() {
      const canvas = document.getElementById('preview-canvas');
      const ctx = canvas.getContext('2d');
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      
      // å›è»¢
      if (rotation !== 0) {
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate((rotation * Math.PI) / 180);
        ctx.translate(-canvas.width / 2, -canvas.height / 2);
      }
      
      // æ˜ã‚‹ã•
      ctx.filter = `brightness(${brightness})`;
      
      // ç”»åƒæç”»
      ctx.drawImage(originalCanvas, 0, 0, canvas.width, canvas.height);
      ctx.restore();
      
      // ãƒˆãƒªãƒŸãƒ³ã‚°æ æç”»
      drawCropArea(ctx);
    }

    // ========================================
    // STEP 8: ãƒˆãƒªãƒŸãƒ³ã‚°æ æç”»
    // ========================================
    function drawCropArea(ctx) {
      const { x, y, width, height } = cropArea;
      
      // åŠé€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
      ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
      ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      
      // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
      ctx.clearRect(x, y, width, height);
      
      // æ ç·š
      ctx.strokeStyle = '#06c755';
      ctx.lineWidth = 2;
      ctx.strokeRect(x, y, width, height);
      
      // ãƒãƒ³ãƒ‰ãƒ«ï¼ˆ4éš…ï¼‰
      const handleSize = 20;
      ctx.fillStyle = '#06c755';
      
      // å·¦ä¸Š
      ctx.fillRect(x - handleSize / 2, y - handleSize / 2, handleSize, handleSize);
      // å³ä¸Š
      ctx.fillRect(x + width - handleSize / 2, y - handleSize / 2, handleSize, handleSize);
      // å·¦ä¸‹
      ctx.fillRect(x - handleSize / 2, y + height - handleSize / 2, handleSize, handleSize);
      // å³ä¸‹
      ctx.fillRect(x + width - handleSize / 2, y + height - handleSize / 2, handleSize, handleSize);
    }

    // ========================================
    // STEP 9: ãƒˆãƒªãƒŸãƒ³ã‚°æ“ä½œ
    // ========================================
    function getTouchPos(canvas, touch) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: touch.clientX - rect.left,
        y: touch.clientY - rect.top
      };
    }

    function getHandleAt(x, y) {
      const handleSize = 20;
      const handles = [
        { name: 'tl', x: cropArea.x, y: cropArea.y },
        { name: 'tr', x: cropArea.x + cropArea.width, y: cropArea.y },
        { name: 'bl', x: cropArea.x, y: cropArea.y + cropArea.height },
        { name: 'br', x: cropArea.x + cropArea.width, y: cropArea.y + cropArea.height }
      ];
      
      for (const handle of handles) {
        if (Math.abs(x - handle.x) < handleSize && Math.abs(y - handle.y) < handleSize) {
          return handle.name;
        }
      }
      
      // æ å†…ã‹ãƒã‚§ãƒƒã‚¯
      if (x >= cropArea.x && x <= cropArea.x + cropArea.width &&
          y >= cropArea.y && y <= cropArea.y + cropArea.height) {
        return 'move';
      }
      
      return null;
    }

    document.getElementById('preview-canvas').addEventListener('touchstart', (e) => {
      e.preventDefault();
      const canvas = e.target;
      const touch = e.touches[0];
      const pos = getTouchPos(canvas, touch);
      
      dragTarget = getHandleAt(pos.x, pos.y);
      if (dragTarget) {
        isDragging = true;
        dragStartX = pos.x;
        dragStartY = pos.y;
      }
    });

    document.getElementById('preview-canvas').addEventListener('touchmove', (e) => {
      if (!isDragging || !dragTarget) return;
      e.preventDefault();
      
      const canvas = e.target;
      const touch = e.touches[0];
      const pos = getTouchPos(canvas, touch);
      
      const dx = pos.x - dragStartX;
      const dy = pos.y - dragStartY;
      
      const minSize = 50;
      
      if (dragTarget === 'move') {
        // æ å…¨ä½“ã‚’ç§»å‹•
        cropArea.x = Math.max(0, Math.min(canvas.width - cropArea.width, cropArea.x + dx));
        cropArea.y = Math.max(0, Math.min(canvas.height - cropArea.height, cropArea.y + dy));
      } else if (dragTarget === 'tl') {
        const newX = Math.min(cropArea.x + cropArea.width - minSize, cropArea.x + dx);
        const newY = Math.min(cropArea.y + cropArea.height - minSize, cropArea.y + dy);
        cropArea.width += cropArea.x - newX;
        cropArea.height += cropArea.y - newY;
        cropArea.x = Math.max(0, newX);
        cropArea.y = Math.max(0, newY);
      } else if (dragTarget === 'tr') {
        const newWidth = Math.max(minSize, cropArea.width + dx);
        const newY = Math.min(cropArea.y + cropArea.height - minSize, cropArea.y + dy);
        cropArea.width = Math.min(canvas.width - cropArea.x, newWidth);
        cropArea.height += cropArea.y - newY;
        cropArea.y = Math.max(0, newY);
      } else if (dragTarget === 'bl') {
        const newX = Math.min(cropArea.x + cropArea.width - minSize, cropArea.x + dx);
        const newHeight = Math.max(minSize, cropArea.height + dy);
        cropArea.width += cropArea.x - newX;
        cropArea.x = Math.max(0, newX);
        cropArea.height = Math.min(canvas.height - cropArea.y, newHeight);
      } else if (dragTarget === 'br') {
        cropArea.width = Math.max(minSize, Math.min(canvas.width - cropArea.x, cropArea.width + dx));
        cropArea.height = Math.max(minSize, Math.min(canvas.height - cropArea.y, cropArea.height + dy));
      }
      
      dragStartX = pos.x;
      dragStartY = pos.y;
      
      redrawPreview();
    });

    document.getElementById('preview-canvas').addEventListener('touchend', () => {
      isDragging = false;
      dragTarget = null;
    });

    // ========================================
    // STEP 10: ç”»åƒé€ä¿¡
    // ========================================
    function generateFinalImage() {
      debugLog('æœ€çµ‚ç”»åƒç”Ÿæˆé–‹å§‹...');
      
      const previewCanvas = document.getElementById('preview-canvas');
      const scale = originalCanvas.width / previewCanvas.width;
      
      // å®Ÿéš›ã®ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã«å¤‰æ›
      const actualCrop = {
        x: cropArea.x * scale,
        y: cropArea.y * scale,
        width: cropArea.width * scale,
        height: cropArea.height * scale
      };
      
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = actualCrop.width;
      finalCanvas.height = actualCrop.height;
      
      const ctx = finalCanvas.getContext('2d');
      ctx.filter = `brightness(${brightness})`;
      
      // ãƒˆãƒªãƒŸãƒ³ã‚° + æ˜ã‚‹ã•é©ç”¨
      ctx.drawImage(
        originalCanvas,
        actualCrop.x, actualCrop.y, actualCrop.width, actualCrop.height,
        0, 0, actualCrop.width, actualCrop.height
      );
      
      debugLog(`æœ€çµ‚ç”»åƒã‚µã‚¤ã‚º: ${finalCanvas.width}x${finalCanvas.height}`);
      return finalCanvas;
    }

    function canvasToBase64(canvas, quality = 0.9) {
      return canvas.toDataURL('image/jpeg', quality).split(',')[1];
    }

    async function uploadImage() {
      try {
        showScreen('processing-screen');
        debugLog('é€ä¿¡å‡¦ç†é–‹å§‹...');
        
        const finalCanvas = generateFinalImage();
        const base64Data = canvasToBase64(finalCanvas);
        const imageSize = Math.round(base64Data.length * 0.75);
        
        debugLog(`ç”»åƒã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å®Œäº† (${(imageSize / 1024 / 1024).toFixed(2)}MB)`);
        
        // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
        if (imageSize > 10 * 1024 * 1024) {
          throw new Error('ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰');
        }
        
        const fileName = `scan_${Date.now()}.jpg`;
        
        const requestData = {
          userId,
          displayName,
          image: {
            fileName,
            imageData: base64Data,
            imageSize
          }
        };
        
        debugLog(`Workersé€ä¿¡: ${WORKER_URL}`);
        debugLog(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿: userId=${userId}, size=${(imageSize/1024/1024).toFixed(2)}MB`);
        
        const response = await fetch(WORKER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’å…ˆã«å–å¾—
        const responseText = await response.text();
        debugLog(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡: status=${response.status}`);
        
        if (!response.ok) {
          // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
          let errorDetail = response.statusText;
          try {
            const errorJson = JSON.parse(responseText);
            if (errorJson.error) {
              errorDetail = errorJson.error;
            }
          } catch (e) {
            // JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã¯responseTextã‚’ãã®ã¾ã¾ä½¿ã†
            errorDetail = responseText || response.statusText;
          }
          
          debugLog(`âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${errorDetail}`);
          throw new Error(errorDetail);
        }
        
        const result = JSON.parse(responseText);
        debugLog(`âœ… é€ä¿¡æˆåŠŸ: ${JSON.stringify(result)}`);
        
        showScreen('complete-screen');
      } catch (error) {
        debugLog(`âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†é¡
        let errorTitle = 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ';
        let errorMessage = error.message;
        
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorTitle = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼';
          errorMessage = 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        } else if (error.message.includes('GEMINI_API_KEY')) {
          errorTitle = 'è¨­å®šã‚¨ãƒ©ãƒ¼';
          errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\n\nè©³ç´°: Gemini APIã‚­ãƒ¼ãŒæœªè¨­å®š';
        } else if (error.message.includes('LINE_CHANNEL_ACCESS_TOKEN')) {
          errorTitle = 'è¨­å®šã‚¨ãƒ©ãƒ¼';
          errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\n\nè©³ç´°: LINEãƒˆãƒ¼ã‚¯ãƒ³ãŒæœªè¨­å®š';
        } else if (error.message.includes('Gemini Vision API Error')) {
          errorTitle = 'AIå‡¦ç†ã‚¨ãƒ©ãƒ¼';
          errorMessage = 'ç”»åƒã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nâ€¢ ã‚ˆã‚Šæ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±ã—ã¦ãã ã•ã„\nâ€¢ ãƒ”ãƒ³ãƒˆã‚’åˆã‚ã›ã¦æ’®å½±ã—ã¦ãã ã•ã„\nâ€¢ ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„';
        } else if (error.message.includes('LINE API Error')) {
          errorTitle = 'LINEé€šçŸ¥ã‚¨ãƒ©ãƒ¼';
          errorMessage = 'å‡¦ç†ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€LINEã¸ã®é€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        }
        
        showError(errorTitle, errorMessage);
      }
    }

    // ========================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    // ========================================
    
    // æ˜ã‚‹ã•ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
    document.getElementById('brightness-slider').addEventListener('input', (e) => {
      brightness = e.target.value / 100;
      document.getElementById('brightness-value').textContent = e.target.value + '%';
      redrawPreview();
    });

    // å›è»¢ãƒœã‚¿ãƒ³
    document.getElementById('rotate-btn').addEventListener('click', () => {
      rotation = (rotation + 90) % 360;
      debugLog(`å›è»¢: ${rotation}åº¦`);
      redrawPreview();
    });

    // æ’®ã‚Šç›´ã—ãƒœã‚¿ãƒ³
    document.getElementById('retake-btn').addEventListener('click', async () => {
      showScreen('camera-screen');
      // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯åœæ­¢ã›ãšå†åˆ©ç”¨
      if (cameraStream && cameraInitialized) {
        const video = document.getElementById('camera-preview');
        video.srcObject = cameraStream;
        debugLog('ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ å†åˆ©ç”¨');
      } else {
        await initCamera();
      }
    });

    // é€ä¿¡ãƒœã‚¿ãƒ³
    document.getElementById('send-btn').addEventListener('click', uploadImage);

    // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³
    document.getElementById('shutter-btn').addEventListener('click', capturePhoto);

    // æ–°ã—ãã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³
    document.getElementById('new-scan-btn').addEventListener('click', async () => {
      showScreen('camera-screen');
      // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯åœæ­¢ã›ãšå†åˆ©ç”¨
      if (cameraStream && cameraInitialized) {
        const video = document.getElementById('camera-preview');
        video.srcObject = cameraStream;
        debugLog('ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ å†åˆ©ç”¨');
      } else {
        await initCamera();
      }
    });

    // ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³
    document.getElementById('retry-btn').addEventListener('click', async () => {
      // æ‹’å¦çŠ¶æ…‹ã®å ´åˆã¯ã€Œå†ãƒã‚§ãƒƒã‚¯ã€æ‰±ã„
      if (cameraPermissionState === 'denied') {
        debugLog('è¨­å®šå¤‰æ›´ç¢ºèª - çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ');
        cameraPermissionState = 'unchecked'; // å†ãƒã‚§ãƒƒã‚¯å¯èƒ½ã«
      }
      
      showScreen('camera-screen');
      await initCamera();
    });

    // ã‚¢ãƒ—ãƒªçµ‚äº†æ™‚ã®ã¿ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
    window.addEventListener('beforeunload', () => {
      stopCamera();
    });

    // ========================================
    // åˆæœŸåŒ–
    // ========================================
    window.addEventListener('DOMContentLoaded', async () => {
      debugLog('ã‚¢ãƒ—ãƒªèµ·å‹•');
      
      const initialized = await initLiff();
      if (!initialized) return;
      
      showScreen('camera-screen');
      await initCamera();
    });
  </script>

</body>
</html>
