<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>„Ç¢„Ç§„Çπ„Çø „Ç´„É°„É©„Çπ„Ç≠„É£„É≥</title>
  
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }
    
    /* Êï∞Âºè„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ËÉåÊôØ */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.1;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    
    .formula {
      position: absolute;
      color: white;
      font-size: 20px;
      animation: float 20s linear infinite;
    }
    
    @keyframes float {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }
    
    /* ÁîªÈù¢ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
    .screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      z-index: 1;
    }
    
    .screen.hidden {
      display: none;
    }
    
    /* „Éò„ÉÉ„ÉÄ„Éº */
    .header {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 5px 10px;
    }
    
    /* „Ç´„É°„É©ÊíÆÂΩ±ÁîªÈù¢ */
    #camera-screen {
      background: black;
    }
    
    #camera-preview {
      width: 100%;
      height: calc(100vh - 150px);
      object-fit: cover;
    }
    
    .camera-controls {
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    #shutter-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: white;
      border: 5px solid #00B900;
      cursor: pointer;
      transition: transform 0.1s;
      font-size: 32px;
    }
    
    #shutter-btn:active {
      transform: scale(0.95);
    }
    
    .camera-hint {
      color: rgba(255, 255, 255, 0.8);
      text-align: center;
      font-size: 14px;
      line-height: 1.6;
    }
    
    /* „Éó„É¨„Éì„É•„ÉºÁ∑®ÈõÜÁîªÈù¢ */
    #preview-screen {
      background: #1a1a1a;
    }
    
    .preview-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #preview-canvas {
      max-width: 100%;
      max-height: 100%;
      display: block;
      touch-action: none;
    }
    
    #crop-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .crop-handle {
      position: absolute;
      width: 20px;
      height: 20px;
      background: #00B900;
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: auto;
      cursor: pointer;
      z-index: 10;
    }
    
    /* „ÉÑ„Éº„É´„Éê„Éº */
    .toolbar {
      background: rgba(0, 0, 0, 0.9);
      padding: 15px;
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    
    .toolbar button {
      background: #00B900;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .toolbar button:active {
      background: #009900;
    }
    
    .brightness-control {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
      min-width: 150px;
    }
    
    .brightness-control label {
      color: white;
      font-size: 12px;
    }
    
    #brightness-slider {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      background: rgba(255, 255, 255, 0.3);
      outline: none;
      border-radius: 3px;
    }
    
    #brightness-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #00B900;
      cursor: pointer;
      border-radius: 50%;
    }
    
    #brightness-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #00B900;
      cursor: pointer;
      border-radius: 50%;
      border: none;
    }
    
    /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */
    .action-buttons {
      background: rgba(0, 0, 0, 0.9);
      padding: 15px;
      display: flex;
      gap: 10px;
    }
    
    .action-buttons button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    #retake-btn {
      background: #666;
      color: white;
    }
    
    #send-btn {
      background: #00B900;
      color: white;
    }
    
    /* Âá¶ÁêÜ‰∏≠ÁîªÈù¢ */
    #processing-screen {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 30px;
      padding: 40px;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .progress-info {
      text-align: center;
      color: white;
    }
    
    .progress-info h2 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .progress-bar {
      width: 280px;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    #progress-fill {
      width: 0%;
      height: 100%;
      background: white;
      transition: width 0.5s;
    }
    
    .progress-text {
      font-size: 14px;
      opacity: 0.9;
      line-height: 1.6;
    }
    
    /* ÂÆå‰∫ÜÁîªÈù¢ */
    #complete-screen {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 30px;
      padding: 40px;
      text-align: center;
    }
    
    .success-icon {
      width: 100px;
      height: 100px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
      animation: scaleIn 0.5s;
    }
    
    @keyframes scaleIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }
    
    .complete-message {
      color: white;
    }
    
    .complete-message h2 {
      font-size: 28px;
      margin-bottom: 15px;
    }
    
    .complete-message p {
      font-size: 16px;
      opacity: 0.9;
      line-height: 1.6;
    }
    
    #back-to-line-btn {
      background: white;
      color: #667eea;
      border: none;
      padding: 18px 40px;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s;
    }
    
    #back-to-line-btn:active {
      transform: scale(0.95);
    }
    
    /* „Ç®„É©„ÉºÁîªÈù¢ */
    #error-screen {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 30px;
      padding: 40px;
      text-align: center;
    }
    
    .error-icon {
      width: 100px;
      height: 100px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
    }
    
    .error-message {
      color: white;
    }
    
    .error-message h2 {
      font-size: 24px;
      margin-bottom: 15px;
    }
    
    .error-message p {
      font-size: 16px;
      opacity: 0.9;
      line-height: 1.6;
    }
    
    #retry-btn {
      background: white;
      color: #f5576c;
      border: none;
      padding: 18px 40px;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
    }
    
    /* „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫ */
    #debug-info {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      color: #00ff00;
      padding: 10px;
      font-family: monospace;
      font-size: 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 9999;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <!-- ËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ -->
  <div class="bg-animation" id="bg-animation"></div>
  
  <!-- „Ç´„É°„É©ÊíÆÂΩ±ÁîªÈù¢ -->
  <div id="camera-screen" class="screen hidden">
    <div class="header">
      <h1>üì∏ „Ç´„É°„É©„Çπ„Ç≠„É£„É≥</h1>
      <button class="close-btn" onclick="closeLiff()">√ó</button>
    </div>
    <video id="camera-preview" autoplay playsinline></video>
    <div class="camera-controls">
      <button id="shutter-btn">üì∏</button>
      <div class="camera-hint">
        üí° Êòé„Çã„ÅÑÂ†¥ÊâÄ„Åß„ÄÅÁúü‰∏ä„Åã„ÇâÊíÆÂΩ±„Åô„Çã„Å®<br>Á∂∫È∫ó„Å´Ë™≠„ÅøÂèñ„Çå„Åæ„Åô
      </div>
    </div>
  </div>
  
  <!-- „Éó„É¨„Éì„É•„ÉºÁ∑®ÈõÜÁîªÈù¢ -->
  <div id="preview-screen" class="screen hidden">
    <div class="header">
      <h1>üìù Á∑®ÈõÜ</h1>
    </div>
    <div class="preview-container">
      <canvas id="preview-canvas"></canvas>
      <div id="crop-overlay">
        <div class="crop-handle" id="handle-tl" style="cursor: nwse-resize;"></div>
        <div class="crop-handle" id="handle-tr" style="cursor: nesw-resize;"></div>
        <div class="crop-handle" id="handle-bl" style="cursor: nesw-resize;"></div>
        <div class="crop-handle" id="handle-br" style="cursor: nwse-resize;"></div>
      </div>
    </div>
    <div class="toolbar">
      <button id="rotate-btn">üîÑ ÂõûËª¢</button>
      <div class="brightness-control">
        <label>‚òÄÔ∏è Êòé„Çã„Åï</label>
        <input type="range" id="brightness-slider" min="50" max="150" value="100">
      </div>
    </div>
    <div class="action-buttons">
      <button id="retake-btn">üîÑ ÊíÆ„ÇäÁõ¥„Åô</button>
      <button id="send-btn">‚úÖ ÈÄÅ‰ø°</button>
    </div>
  </div>
  
  <!-- Âá¶ÁêÜ‰∏≠ÁîªÈù¢ -->
  <div id="processing-screen" class="screen hidden">
    <div class="spinner"></div>
    <div class="progress-info">
      <h2>‚è≥ AIËß£Êûê‰∏≠...</h2>
      <div class="progress-bar">
        <div id="progress-fill"></div>
      </div>
      <p class="progress-text">
        ÁîªÂÉè„ÇíËß£Êûê„Åó„Å¶„ÅÑ„Åæ„Åô<br>
        20„Äú40Áßí„Åª„Å©„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ
      </p>
    </div>
  </div>
  
  <!-- ÂÆå‰∫ÜÁîªÈù¢ -->
  <div id="complete-screen" class="screen hidden">
    <div class="success-icon">‚úÖ</div>
    <div class="complete-message">
      <h2>ÊñáÂ≠óËµ∑„Åì„ÅóÂÆå‰∫Ü!</h2>
      <p>
        ÁµêÊûú„ÅØLINE„Éà„Éº„ÇØ„Åß<br>
        Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ
      </p>
    </div>
    <button id="back-to-line-btn">üì± LINE„Å´Êàª„Çã</button>
  </div>
  
  <!-- „Ç®„É©„ÉºÁîªÈù¢ -->
  <div id="error-screen" class="screen hidden">
    <div class="error-icon">‚ùå</div>
    <div class="error-message">
      <h2 id="error-title">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</h2>
      <p id="error-detail">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ</p>
    </div>
    <button id="retry-btn">üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åô</button>
  </div>
  
  <!-- „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± -->
  <div id="debug-info" class="hidden"></div>

  <script>
    // ========================================
    // Ë®≠ÂÆö
    // ========================================
    const LIFF_ID = '2008235357-XXXXXXXX';  // ‚Üê „ÅÇ„Å™„Åü„ÅÆLIFF ID„Å´Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ
    const WORKER_URL = 'https://aista-pdf-processor.luminalice-reg-tea-sun-red-9b0.workers.dev/upload-image';
    const DEBUG_MODE = true;  // Êú¨Áï™: false
    
    // ========================================
    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    // ========================================
    let userId = null;
    let displayName = null;
    let cameraStream = null;
    let originalCanvas = null;
    let cropArea = null;
    let rotation = 0;
    let brightness = 1.0;
    let needsRedraw = false;
    
    // ========================================
    // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
    // ========================================
    const debugLogs = [];
    
    function debugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      debugLogs.push(logMessage);
      console.log(logMessage);
      
      if (DEBUG_MODE) {
        const debugDiv = document.getElementById('debug-info');
        if (debugDiv) {
          debugDiv.textContent = debugLogs.slice(-10).join('\n');
          debugDiv.classList.remove('hidden');
        }
      }
    }
    
    // ========================================
    // ËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
    // ========================================
    function initBackgroundAnimation() {
      const formulas = ['‚à´', '‚àë', 'œÄ', 'Œ±', 'Œ≤', 'Œ∏', '‚àö', '‚àû', 'Œî', 'Œ£'];
      const container = document.getElementById('bg-animation');
      
      for (let i = 0; i < 15; i++) {
        const formula = document.createElement('div');
        formula.className = 'formula';
        formula.textContent = formulas[Math.floor(Math.random() * formulas.length)];
        formula.style.left = Math.random() * 100 + '%';
        formula.style.animationDelay = Math.random() * 20 + 's';
        formula.style.fontSize = (15 + Math.random() * 15) + 'px';
        container.appendChild(formula);
      }
    }
    
    // ========================================
    // ÁîªÈù¢ÈÅ∑Áßª
    // ========================================
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
      document.getElementById(screenId).classList.remove('hidden');
      debugLog(`ÁîªÈù¢Ë°®Á§∫: ${screenId}`);
    }
    
    // ========================================
    // LIFFÂàùÊúüÂåñ
    // ========================================
    async function initLiff() {
      try {
        debugLog('LIFFÂàùÊúüÂåñÈñãÂßã...');
        
        await liff.init({ liffId: LIFF_ID });
        debugLog('‚úÖ LIFFÂàùÊúüÂåñÊàêÂäü');
        
        if (!liff.isLoggedIn()) {
          debugLog('Êú™„É≠„Ç∞„Ç§„É≥ ‚Üí „É≠„Ç∞„Ç§„É≥ÂÆüË°å');
          liff.login();
          return;
        }
        
        const profile = await liff.getProfile();
        userId = profile.userId;
        displayName = profile.displayName;
        debugLog(`‚úÖ „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±ÂèñÂæó: ${displayName} (${userId})`);
        
        // „Ç´„É°„É©ÁîªÈù¢Ë°®Á§∫
        showScreen('camera-screen');
        await initCamera();
        
      } catch (error) {
        debugLog(`‚ùå LIFFÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`);
        showError('LIFFÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', error.message);
      }
    }
    
    // ========================================
    // „Ç´„É°„É©ÂàùÊúüÂåñ
    // ========================================
    async function initCamera() {
      try {
        debugLog('„Ç´„É°„É©ÂàùÊúüÂåñÈñãÂßã...');
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('„Åä‰Ωø„ÅÑ„ÅÆÁ´ØÊú´„Åß„ÅØ„Ç´„É°„É©Ê©üËÉΩ„Çí„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åõ„Çì');
        }
        
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });
        
        cameraStream = stream;
        const video = document.getElementById('camera-preview');
        video.srcObject = stream;
        await video.play();
        
        debugLog('‚úÖ „Ç´„É°„É©Ëµ∑ÂãïÊàêÂäü');
        
      } catch (error) {
        debugLog(`‚ùå „Ç´„É°„É©„Ç®„É©„Éº: ${error.message}`);
        
        if (error.name === 'NotAllowedError') {
          showError(
            '„Ç´„É°„É©„ÅÆ‰ΩøÁî®Ë®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô',
            'Ë®≠ÂÆö ‚Üí „Ç¢„Éó„É™ ‚Üí LINE ‚Üí Ê®©Èôê ‚Üí „Ç´„É°„É©„ÇíON„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
          );
        } else {
          showError('„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', error.message);
        }
      }
    }
    
    // ========================================
    // ÊíÆÂΩ±Âá¶ÁêÜ
    // ========================================
    document.getElementById('shutter-btn').addEventListener('click', () => {
      try {
        debugLog('ÊíÆÂΩ±ÈñãÂßã...');
        
        const video = document.getElementById('camera-preview');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        originalCanvas = canvas;
        
        // „Ç´„É°„É©ÂÅúÊ≠¢
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
        }
        
        debugLog(`‚úÖ ÊíÆÂΩ±ÂÆå‰∫Ü (${canvas.width}x${canvas.height})`);
        
        // „Éó„É¨„Éì„É•„ÉºÁîªÈù¢„Å´ÈÅ∑Áßª
        showPreview();
        
      } catch (error) {
        debugLog(`‚ùå ÊíÆÂΩ±„Ç®„É©„Éº: ${error.message}`);
        showError('ÊíÆÂΩ±„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', error.message);
      }
    });
    
    // ========================================
    // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
    // ========================================
    function showPreview() {
      showScreen('preview-screen');
      
      const previewCanvas = document.getElementById('preview-canvas');
      const container = previewCanvas.parentElement;
      
      // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫Ë™øÊï¥(„Ç¢„Çπ„Éö„ÇØ„ÉàÊØîÁ∂≠ÊåÅ)
      const containerWidth = container.clientWidth;
      const containerHeight = container.clientHeight;
      const imageRatio = originalCanvas.width / originalCanvas.height;
      const containerRatio = containerWidth / containerHeight;
      
      if (imageRatio > containerRatio) {
        previewCanvas.width = containerWidth;
        previewCanvas.height = containerWidth / imageRatio;
      } else {
        previewCanvas.height = containerHeight;
        previewCanvas.width = containerHeight * imageRatio;
      }
      
      // „Éà„É™„Éü„É≥„Ç∞È†òÂüüÂàùÊúüÂåñ
      const margin = 0.1;
      cropArea = {
        x: previewCanvas.width * margin,
        y: previewCanvas.height * margin,
        width: previewCanvas.width * (1 - margin * 2),
        height: previewCanvas.height * (1 - margin * 2)
      };
      
      // ÊèèÁîªÈñãÂßã
      redrawPreview();
      startAnimationLoop();
      
      // „Éà„É™„Éü„É≥„Ç∞„Éè„É≥„Éâ„É´„Ç§„Éô„É≥„Éà
      initCropHandles();
    }
    
    // ========================================
    // „Éó„É¨„Éì„É•„ÉºÂÜçÊèèÁîª
    // ========================================
    function redrawPreview() {
      const canvas = document.getElementById('preview-canvas');
      const ctx = canvas.getContext('2d');
      
      // „ÇØ„É™„Ç¢
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // ÂÖÉÁîªÂÉè„ÇíÊèèÁîª(Êòé„Çã„ÅïÈÅ©Áî®)
      ctx.filter = `brightness(${brightness})`;
      
      // ÂõûËª¢ÈÅ©Áî®
      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(rotation * Math.PI / 180);
      
      const scale = Math.min(
        canvas.width / originalCanvas.width,
        canvas.height / originalCanvas.height
      );
      
      ctx.drawImage(
        originalCanvas,
        -originalCanvas.width * scale / 2,
        -originalCanvas.height * scale / 2,
        originalCanvas.width * scale,
        originalCanvas.height * scale
      );
      
      ctx.restore();
      ctx.filter = 'none';
      
      // „Éà„É™„Éü„É≥„Ç∞Êû†ÊèèÁîª
      drawCropArea(ctx);
      
      // „Éè„É≥„Éâ„É´‰ΩçÁΩÆÊõ¥Êñ∞
      updateCropHandles();
    }
    
    // ========================================
    // „Éà„É™„Éü„É≥„Ç∞Êû†ÊèèÁîª
    // ========================================
    function drawCropArea(ctx) {
      // ÂçäÈÄèÊòé„Ç™„Éº„Éê„Éº„É¨„Ç§
      ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
      ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      
      // „Éà„É™„Éü„É≥„Ç∞È†òÂüü„Çí„ÇØ„É™„Ç¢
      ctx.clearRect(cropArea.x, cropArea.y, cropArea.width, cropArea.height);
      
      // Êû†Á∑ö
      ctx.strokeStyle = '#00B900';
      ctx.lineWidth = 2;
      ctx.setLineDash([10, 5]);
      ctx.strokeRect(cropArea.x, cropArea.y, cropArea.width, cropArea.height);
      ctx.setLineDash([]);
    }
    
    // ========================================
    // „Éà„É™„Éü„É≥„Ç∞„Éè„É≥„Éâ„É´
    // ========================================
    function initCropHandles() {
      const canvas = document.getElementById('preview-canvas');
      let dragHandle = null;
      let startX = 0;
      let startY = 0;
      
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        startX = x;
        startY = y;
        
        // „Å©„ÅÆ„Éè„É≥„Éâ„É´„Åå„Çø„ÉÉ„ÉÅ„Åï„Çå„Åü„ÅãÂà§ÂÆö
        const threshold = 30;
        if (isNear(x, y, cropArea.x, cropArea.y, threshold)) {
          dragHandle = 'tl';
        } else if (isNear(x, y, cropArea.x + cropArea.width, cropArea.y, threshold)) {
          dragHandle = 'tr';
        } else if (isNear(x, y, cropArea.x, cropArea.y + cropArea.height, threshold)) {
          dragHandle = 'bl';
        } else if (isNear(x, y, cropArea.x + cropArea.width, cropArea.y + cropArea.height, threshold)) {
          dragHandle = 'br';
        } else if (x > cropArea.x && x < cropArea.x + cropArea.width &&
                   y > cropArea.y && y < cropArea.y + cropArea.height) {
          dragHandle = 'move';
        }
      });
      
      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!dragHandle) return;
        
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        const deltaX = x - startX;
        const deltaY = y - startY;
        
        switch (dragHandle) {
          case 'tl':
            cropArea.x += deltaX;
            cropArea.y += deltaY;
            cropArea.width -= deltaX;
            cropArea.height -= deltaY;
            break;
          case 'tr':
            cropArea.y += deltaY;
            cropArea.width += deltaX;
            cropArea.height -= deltaY;
            break;
          case 'bl':
            cropArea.x += deltaX;
            cropArea.width -= deltaX;
            cropArea.height += deltaY;
            break;
          case 'br':
            cropArea.width += deltaX;
            cropArea.height += deltaY;
            break;
          case 'move':
            cropArea.x += deltaX;
            cropArea.y += deltaY;
            break;
        }
        
        // ÊúÄÂ∞è„Çµ„Ç§„Ç∫Âà∂Èôê
        cropArea.width = Math.max(50, cropArea.width);
        cropArea.height = Math.max(50, cropArea.height);
        
        // Â¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ
        cropArea.x = Math.max(0, Math.min(cropArea.x, canvas.width - cropArea.width));
        cropArea.y = Math.max(0, Math.min(cropArea.y, canvas.height - cropArea.height));
        
        startX = x;
        startY = y;
        
        needsRedraw = true;
      });
      
      canvas.addEventListener('touchend', () => {
        dragHandle = null;
      });
    }
    
    function isNear(x, y, targetX, targetY, threshold) {
      return Math.abs(x - targetX) < threshold && Math.abs(y - targetY) < threshold;
    }
    
    function updateCropHandles() {
      document.getElementById('handle-tl').style.left = cropArea.x + 'px';
      document.getElementById('handle-tl').style.top = cropArea.y + 'px';
      
      document.getElementById('handle-tr').style.left = (cropArea.x + cropArea.width) + 'px';
      document.getElementById('handle-tr').style.top = cropArea.y + 'px';
      
      document.getElementById('handle-bl').style.left = cropArea.x + 'px';
      document.getElementById('handle-bl').style.top = (cropArea.y + cropArea.height) + 'px';
      
      document.getElementById('handle-br').style.left = (cropArea.x + cropArea.width) + 'px';
      document.getElementById('handle-br').style.top = (cropArea.y + cropArea.height) + 'px';
    }
    
    // ========================================
    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„Éó
    // ========================================
    function startAnimationLoop() {
      function animate() {
        if (needsRedraw) {
          redrawPreview();
          needsRedraw = false;
        }
        requestAnimationFrame(animate);
      }
      animate();
    }
    
    // ========================================
    // ÂõûËª¢„Éú„Çø„É≥
    // ========================================
    document.getElementById('rotate-btn').addEventListener('click', () => {
      rotation = (rotation + 90) % 360;
      needsRedraw = true;
      debugLog(`ÂõûËª¢: ${rotation}Â∫¶`);
    });
    
    // ========================================
    // Êòé„Çã„ÅïË™øÊï¥
    // ========================================
    document.getElementById('brightness-slider').addEventListener('input', (e) => {
      brightness = parseInt(e.target.value) / 100;
      needsRedraw = true;
      debugLog(`Êòé„Çã„Åï: ${brightness}`);
    });
    
    // ========================================
    // ÊíÆ„ÇäÁõ¥„Åó„Éú„Çø„É≥
    // ========================================
    document.getElementById('retake-btn').addEventListener('click', () => {
      rotation = 0;
      brightness = 1.0;
      document.getElementById('brightness-slider').value = 100;
      showScreen('camera-screen');
      initCamera();
    });
    
    // ========================================
    // ÈÄÅ‰ø°Âá¶ÁêÜ
    // ========================================
    document.getElementById('send-btn').addEventListener('click', async () => {
      try {
        debugLog('ÈÄÅ‰ø°Âá¶ÁêÜÈñãÂßã...');
        showScreen('processing-screen');
        
        // „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÈñãÂßã
        updateProgress(10);
        
        // ÊúÄÁµÇÁîªÂÉèÁîüÊàê
        const finalCanvas = await generateFinalImage();
        updateProgress(30);
        
        // Base64„Ç®„É≥„Ç≥„Éº„Éâ
        const base64Data = await canvasToBase64(finalCanvas);
        const imageSize = Math.round(base64Data.length * 0.75);
        debugLog(`ÁîªÂÉè„Ç®„É≥„Ç≥„Éº„ÉâÂÆå‰∫Ü (${(imageSize / 1024 / 1024).toFixed(2)}MB)`);
        updateProgress(50);
        
        // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        const response = await uploadImage({
          userId,
          displayName,
          image: {
            fileName: `scan_${Date.now()}.jpg`,
            imageData: base64Data,
            imageSize
          }
        });
        
        updateProgress(100);
        
        debugLog('‚úÖ ÈÄÅ‰ø°ÊàêÂäü');
        
        // ÂÆå‰∫ÜÁîªÈù¢Ë°®Á§∫
        setTimeout(() => {
          showScreen('complete-screen');
        }, 500);
        
      } catch (error) {
        debugLog(`‚ùå ÈÄÅ‰ø°„Ç®„É©„Éº: ${error.message}`);
        showError('ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', error.message);
      }
    });
    
    // ========================================
    // ÊúÄÁµÇÁîªÂÉèÁîüÊàê
    // ========================================
    async function generateFinalImage() {
      const canvas = document.getElementById('preview-canvas');
      const finalCanvas = document.createElement('canvas');
      
      // „Éà„É™„Éü„É≥„Ç∞ÈÅ©Áî®
      finalCanvas.width = cropArea.width;
      finalCanvas.height = cropArea.height;
      
      const ctx = finalCanvas.getContext('2d');
      ctx.filter = `brightness(${brightness})`;
      
      // ÂõûËª¢ËÄÉÊÖÆ„Åó„Å¶ÊèèÁîª
      ctx.save();
      ctx.translate(finalCanvas.width / 2, finalCanvas.height / 2);
      ctx.rotate(rotation * Math.PI / 180);
      
      const scale = Math.min(
        canvas.width / originalCanvas.width,
        canvas.height / originalCanvas.height
      );
      
      // „Éà„É™„Éü„É≥„Ç∞È†òÂüü„ÅÆ„ÅøÊäΩÂá∫
      const srcX = (cropArea.x - (canvas.width - originalCanvas.width * scale) / 2) / scale;
      const srcY = (cropArea.y - (canvas.height - originalCanvas.height * scale) / 2) / scale;
      const srcW = cropArea.width / scale;
      const srcH = cropArea.height / scale;
      
      ctx.drawImage(
        originalCanvas,
        srcX, srcY, srcW, srcH,
        -cropArea.width / 2, -cropArea.height / 2,
        cropArea.width, cropArea.height
      );
      
      ctx.restore();
      
      return finalCanvas;
    }
    
    // ========================================
    // Base64„Ç®„É≥„Ç≥„Éº„Éâ
    // ========================================
    function canvasToBase64(canvas, quality = 0.9) {
      return new Promise((resolve, reject) => {
        canvas.toBlob((blob) => {
          if (!blob) {
            reject(new Error('BlobÁîüÊàêÂ§±Êïó'));
            return;
          }
          
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
          };
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      });
    }
    
    // ========================================
    // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
    // ========================================
    async function uploadImage(data) {
      const response = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      return await response.json();
    }
    
    // ========================================
    // „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÊõ¥Êñ∞
    // ========================================
    function updateProgress(percent) {
      document.getElementById('progress-fill').style.width = percent + '%';
    }
    
    // ========================================
    // „Ç®„É©„ÉºË°®Á§∫
    // ========================================
    function showError(title, detail) {
      document.getElementById('error-title').textContent = title;
      document.getElementById('error-detail').textContent = detail;
      showScreen('error-screen');
    }
    
    document.getElementById('retry-btn').addEventListener('click', () => {
      showScreen('camera-screen');
      initCamera();
    });
    
    // ========================================
    // LINE„Å´Êàª„Çã
    // ========================================
    document.getElementById('back-to-line-btn').addEventListener('click', () => {
      closeLiff();
    });
    
    function closeLiff() {
      if (liff.isInClient()) {
        liff.closeWindow();
      } else {
        window.close();
      }
    }
    
    // ========================================
    // ÂàùÊúüÂåñ
    // ========================================
    window.addEventListener('DOMContentLoaded', () => {
      initBackgroundAnimation();
      initLiff();
    });
  </script>
</body>
</html>