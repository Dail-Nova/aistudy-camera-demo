<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ã‚¢ã‚¤ã‚¹ã‚¿ ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³</title>
  
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }
    
    /* æ•°å¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.1;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    
    .formula {
      position: absolute;
      color: white;
      font-size: 20px;
      animation: float 20s linear infinite;
    }
    
    @keyframes float {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }
    
    /* ç”»é¢å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      z-index: 1;
    }
    
    .screen.hidden {
      display: none;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 5px 10px;
    }
    
    /* ã‚«ãƒ¡ãƒ©æ’®å½±ç”»é¢ */
    #camera-screen {
      background: black;
    }
    
    #camera-preview {
      width: 100%;
      height: calc(100vh - 150px);
      object-fit: cover;
    }
    
    .camera-controls {
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    #shutter-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: white;
      border: 5px solid #00B900;
      cursor: pointer;
      transition: transform 0.1s;
      font-size: 32px;
    }
    
    #shutter-btn:active {
      transform: scale(0.95);
    }
    
    .camera-hint {
      color: rgba(255, 255, 255, 0.8);
      text-align: center;
      font-size: 14px;
      line-height: 1.6;
    }
    
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç·¨é›†ç”»é¢ */
    #preview-screen {
      background: #1a1a1a;
    }
    
    .preview-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #preview-canvas {
      max-width: 100%;
      max-height: 100%;
      display: block;
      touch-action: none;
    }
    
    #crop-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .crop-handle {
      position: absolute;
      width: 20px;
      height: 20px;
      background: #00B900;
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: auto;
      cursor: pointer;
      z-index: 10;
    }
    
    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .toolbar {
      background: rgba(0, 0, 0, 0.9);
      padding: 15px;
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    
    .toolbar button {
      background: #00B900;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .toolbar button:active {
      background: #009900;
    }
    
    .brightness-control {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
      min-width: 150px;
    }
    
    .brightness-control label {
      color: white;
      font-size: 12px;
    }
    
    #brightness-slider {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      background: rgba(255, 255, 255, 0.3);
      outline: none;
      border-radius: 3px;
    }
    
    #brightness-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #00B900;
      cursor: pointer;
      border-radius: 50%;
    }
    
    #brightness-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #00B900;
      cursor: pointer;
      border-radius: 50%;
      border: none;
    }
    
    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .action-buttons {
      background: rgba(0, 0, 0, 0.9);
      padding: 15px;
      display: flex;
      gap: 10px;
    }
    
    .action-buttons button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    #retake-btn {
      background: #666;
      color: white;
    }
    
    #send-btn {
      background: #00B900;
      color: white;
    }
    
    /* å‡¦ç†ä¸­ç”»é¢ */
    #processing-screen {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 30px;
      padding: 40px;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .progress-info {
      text-align: center;
      color: white;
    }
    
    .progress-info h2 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .progress-bar {
      width: 280px;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    #progress-fill {
      width: 0%;
      height: 100%;
      background: white;
      transition: width 0.5s;
    }
    
    .progress-text {
      font-size: 14px;
      opacity: 0.9;
      line-height: 1.6;
    }
    
    /* å®Œäº†ç”»é¢ */
    #complete-screen {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 30px;
      padding: 40px;
      text-align: center;
    }
    
    .success-icon {
      width: 100px;
      height: 100px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
      animation: scaleIn 0.5s;
    }
    
    @keyframes scaleIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }
    
    .complete-message {
      color: white;
    }
    
    .complete-message h2 {
      font-size: 28px;
      margin-bottom: 15px;
    }
    
    .complete-message p {
      font-size: 16px;
      opacity: 0.9;
      line-height: 1.6;
    }
    
    #back-to-line-btn {
      background: white;
      color: #667eea;
      border: none;
      padding: 18px 40px;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s;
    }
    
    #back-to-line-btn:active {
      transform: scale(0.95);
    }
    
    /* ã‚¨ãƒ©ãƒ¼ç”»é¢ */
    #error-screen {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 30px;
      padding: 40px;
      text-align: center;
    }
    
    .error-icon {
      width: 100px;
      height: 100px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
    }
    
    .error-message {
      color: white;
    }
    
    .error-message h2 {
      font-size: 24px;
      margin-bottom: 15px;
    }
    
    .error-message p {
      font-size: 16px;
      opacity: 0.9;
      line-height: 1.6;
    }
    
    #retry-btn {
      background: white;
      color: #f5576c;
      border: none;
      padding: 18px 40px;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
    }
    
    /* ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º */
    #debug-info {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      color: #00ff00;
      padding: 10px;
      font-family: monospace;
      font-size: 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 9999;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <!-- èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="bg-animation" id="bg-animation"></div>
  
  <!-- ã‚«ãƒ¡ãƒ©æ’®å½±ç”»é¢ -->
  <div id="camera-screen" class="screen hidden">
    <div class="header">
      <h1>ğŸ“¸ ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³</h1>
      <button class="close-btn" onclick="closeLiff()">Ã—</button>
    </div>
    <video id="camera-preview" autoplay playsinline></video>
    <div class="camera-controls">
      <button id="shutter-btn">ğŸ“¸</button>
      <div class="camera-hint">
        ğŸ’¡ æ˜ã‚‹ã„å ´æ‰€ã§ã€çœŸä¸Šã‹ã‚‰æ’®å½±ã™ã‚‹ã¨<br>ç¶ºéº—ã«èª­ã¿å–ã‚Œã¾ã™
      </div>
    </div>
  </div>
  
  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç·¨é›†ç”»é¢ -->
  <div id="preview-screen" class="screen hidden">
    <div class="header">
      <h1>ğŸ“ ç·¨é›†</h1>
    </div>
    <div class="preview-container">
      <canvas id="preview-canvas"></canvas>
      <div id="crop-overlay">
        <div class="crop-handle" id="handle-tl" style="cursor: nwse-resize;"></div>
        <div class="crop-handle" id="handle-tr" style="cursor: nesw-resize;"></div>
        <div class="crop-handle" id="handle-bl" style="cursor: nesw-resize;"></div>
        <div class="crop-handle" id="handle-br" style="cursor: nwse-resize;"></div>
      </div>
    </div>
    <div class="toolbar">
      <button id="rotate-btn">ğŸ”„ å›è»¢</button>
      <div class="brightness-control">
        <label>â˜€ï¸ æ˜ã‚‹ã•</label>
        <input type="range" id="brightness-slider" min="50" max="150" value="100">
      </div>
    </div>
    <div class="action-buttons">
      <button id="retake-btn">ğŸ”„ æ’®ã‚Šç›´ã™</button>
      <button id="send-btn">âœ… é€ä¿¡</button>
    </div>
  </div>
  
  <!-- å‡¦ç†ä¸­ç”»é¢ -->
  <div id="processing-screen" class="screen hidden">
    <div class="spinner"></div>
    <div class="progress-info">
      <h2>â³ AIè§£æä¸­...</h2>
      <div class="progress-bar">
        <div id="progress-fill"></div>
      </div>
      <p class="progress-text">
        ç”»åƒã‚’è§£æã—ã¦ã„ã¾ã™<br>
        20ã€œ40ç§’ã»ã©ãŠå¾…ã¡ãã ã•ã„
      </p>
    </div>
  </div>
  
  <!-- å®Œäº†ç”»é¢ -->
  <div id="complete-screen" class="screen hidden">
    <div class="success-icon">âœ…</div>
    <div class="complete-message">
      <h2>æ–‡å­—èµ·ã“ã—å®Œäº†!</h2>
      <p>
        çµæœã¯LINEãƒˆãƒ¼ã‚¯ã§<br>
        ç¢ºèªã—ã¦ãã ã•ã„
      </p>
    </div>
    <button id="back-to-line-btn">ğŸ“± LINEã«æˆ»ã‚‹</button>
  </div>
  
  <!-- ã‚¨ãƒ©ãƒ¼ç”»é¢ -->
  <div id="error-screen" class="screen hidden">
    <div class="error-icon">âŒ</div>
    <div class="error-message">
      <h2 id="error-title">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
      <p id="error-detail">ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„</p>
    </div>
    <button id="retry-btn">ğŸ”„ ã‚‚ã†ä¸€åº¦è©¦ã™</button>
  </div>
  
  <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
  <div id="debug-info" class="hidden"></div>

  <script>
    // ========================================
    // è¨­å®š
    // ========================================
    const LIFF_ID = '2008235357-XXXXXXXX';  // â† ã‚ãªãŸã®LIFF IDã«å¤‰æ›´ã—ã¦ãã ã•ã„
    const WORKER_URL = 'https://aista-pdf-processor.luminalice-reg-tea-sun-red-9b0.workers.dev/upload-image';
    const DEBUG_MODE = true;  // æœ¬ç•ª: false
    
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ========================================
    let userId = null;
    let displayName = null;
    let cameraStream = null;
    let originalCanvas = null;
    let cropArea = null;
    let rotation = 0;
    let brightness = 1.0;
    let needsRedraw = false;
    
    // ========================================
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    // ========================================
    const debugLogs = [];
    
    function debugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      debugLogs.push(logMessage);
      console.log(logMessage);
      
      if (DEBUG_MODE) {
        const debugDiv = document.getElementById('debug-info');
        if (debugDiv) {
          debugDiv.textContent = debugLogs.slice(-10).join('\n');
          debugDiv.classList.remove('hidden');
        }
      }
    }
    
    // ========================================
    // èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    // ========================================
    function initBackgroundAnimation() {
      const formulas = ['âˆ«', 'âˆ‘', 'Ï€', 'Î±', 'Î²', 'Î¸', 'âˆš', 'âˆ', 'Î”', 'Î£'];
      const container = document.getElementById('bg-animation');
      
      for (let i = 0; i < 15; i++) {
        const formula = document.createElement('div');
        formula.className = 'formula';
        formula.textContent = formulas[Math.floor(Math.random() * formulas.length)];
        formula.style.left = Math.random() * 100 + '%';
        formula.style.animationDelay = Math.random() * 20 + 's';
        formula.style.fontSize = (15 + Math.random() * 15) + 'px';
        container.appendChild(formula);
      }
    }
    
    // ========================================
    // ç”»é¢é·ç§»
    // ========================================
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
      document.getElementById(screenId).classList.remove('hidden');
      debugLog(`ç”»é¢è¡¨ç¤º: ${screenId}`);
    }
    
    // ========================================
    // LIFFåˆæœŸåŒ–
    // ========================================
    async function initLiff() {
      try {
        debugLog('LIFFåˆæœŸåŒ–é–‹å§‹...');
        
        await liff.init({ liffId: LIFF_ID });
        debugLog('âœ… LIFFåˆæœŸåŒ–æˆåŠŸ');
        
        if (!liff.isLoggedIn()) {
          debugLog('æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ');
          liff.login();
          return;
        }
        
        const profile = await liff.getProfile();
        userId = profile.userId;
        displayName = profile.displayName;
        debugLog(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—: ${displayName} (${userId})`);
        
        // ã‚«ãƒ¡ãƒ©ç”»é¢è¡¨ç¤º
        showScreen('camera-screen');
        await initCamera();
        
      } catch (error) {
        debugLog(`âŒ LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        showError('LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', error.message);
      }
    }
    
    // ========================================
    // ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–
    // ========================================
    async function initCamera() {
      try {
        debugLog('ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–é–‹å§‹...');
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('ãŠä½¿ã„ã®ç«¯æœ«ã§ã¯ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“');
        }
        
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });
        
        cameraStream = stream;
        const video = document.getElementById('camera-preview');
        video.srcObject = stream;
        await video.play();
        
        debugLog('âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ');
        
      } catch (error) {
        debugLog(`âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        
        if (error.name === 'NotAllowedError') {
          showError(
            'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨è¨±å¯ãŒå¿…è¦ã§ã™',
            'è¨­å®š â†’ ã‚¢ãƒ—ãƒª â†’ LINE â†’ æ¨©é™ â†’ ã‚«ãƒ¡ãƒ©ã‚’ONã«ã—ã¦ãã ã•ã„'
          );
        } else {
          showError('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ', error.message);
        }
      }
    }
    
    // ========================================
    // æ’®å½±å‡¦ç†
    // ========================================
    document.getElementById('shutter-btn').addEventListener('click', () => {
      try {
        debugLog('æ’®å½±é–‹å§‹...');
        
        const video = document.getElementById('camera-preview');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        originalCanvas = canvas;
        
        // ã‚«ãƒ¡ãƒ©åœæ­¢
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
        }
        
        debugLog(`âœ… æ’®å½±å®Œäº† (${canvas.width}x${canvas.height})`);
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã«é·ç§»
        showPreview();
        
      } catch (error) {
        debugLog(`âŒ æ’®å½±ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        showError('æ’®å½±ã«å¤±æ•—ã—ã¾ã—ãŸ', error.message);
      }
    });
    
    // ========================================
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    // ========================================
    function showPreview() {
      showScreen('preview-screen');
      
      const previewCanvas = document.getElementById('preview-canvas');
      const container = previewCanvas.parentElement;
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´(ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒ)
      const containerWidth = container.clientWidth;
      const containerHeight = container.clientHeight;
      const imageRatio = originalCanvas.width / originalCanvas.height;
      const containerRatio = containerWidth / containerHeight;
      
      if (imageRatio > containerRatio) {
        previewCanvas.width = containerWidth;
        previewCanvas.height = containerWidth / imageRatio;
      } else {
        previewCanvas.height = containerHeight;
        previewCanvas.width = containerHeight * imageRatio;
      }
      
      // ãƒˆãƒªãƒŸãƒ³ã‚°é ˜åŸŸåˆæœŸåŒ–
      const margin = 0.1;
      cropArea = {
        x: previewCanvas.width * margin,
        y: previewCanvas.height * margin,
        width: previewCanvas.width * (1 - margin * 2),
        height: previewCanvas.height * (1 - margin * 2)
      };
      
      // æç”»é–‹å§‹
      redrawPreview();
      startAnimationLoop();
      
      // ãƒˆãƒªãƒŸãƒ³ã‚°ãƒãƒ³ãƒ‰ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
      initCropHandles();
    }
    
    // ========================================
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†æç”»
    // ========================================
    function redrawPreview() {
      const canvas = document.getElementById('preview-canvas');
      const ctx = canvas.getContext('2d');
      
      // ã‚¯ãƒªã‚¢
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // å…ƒç”»åƒã‚’æç”»(æ˜ã‚‹ã•é©ç”¨)
      ctx.filter = `brightness(${brightness})`;
      
      // å›è»¢é©ç”¨
      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(rotation * Math.PI / 180);
      
      const scale = Math.min(
        canvas.width / originalCanvas.width,
        canvas.height / originalCanvas.height
      );
      
      ctx.drawImage(
        originalCanvas,
        -originalCanvas.width * scale / 2,
        -originalCanvas.height * scale / 2,
        originalCanvas.width * scale,
        originalCanvas.height * scale
      );
      
      ctx.restore();
      ctx.filter = 'none';
      
      // ãƒˆãƒªãƒŸãƒ³ã‚°æ æç”»
      drawCropArea(ctx);
      
      // ãƒãƒ³ãƒ‰ãƒ«ä½ç½®æ›´æ–°
      updateCropHandles();
    }
    
    // ========================================
    // ãƒˆãƒªãƒŸãƒ³ã‚°æ æç”»
    // ========================================
    function drawCropArea(ctx) {
      // åŠé€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
      ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
      ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      
      // ãƒˆãƒªãƒŸãƒ³ã‚°é ˜åŸŸã‚’ã‚¯ãƒªã‚¢
      ctx.clearRect(cropArea.x, cropArea.y, cropArea.width, cropArea.height);
      
      // æ ç·š
      ctx.strokeStyle = '#00B900';
      ctx.lineWidth = 2;
      ctx.setLineDash([10, 5]);
      ctx.strokeRect(cropArea.x, cropArea.y, cropArea.width, cropArea.height);
      ctx.setLineDash([]);
    }
    
    // ========================================
    // ãƒˆãƒªãƒŸãƒ³ã‚°ãƒãƒ³ãƒ‰ãƒ«
    // ========================================
    function initCropHandles() {
      const canvas = document.getElementById('preview-canvas');
      let dragHandle = null;
      let startX = 0;
      let startY = 0;
      
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        startX = x;
        startY = y;
        
        // ã©ã®ãƒãƒ³ãƒ‰ãƒ«ãŒã‚¿ãƒƒãƒã•ã‚ŒãŸã‹åˆ¤å®š
        const threshold = 30;
        if (isNear(x, y, cropArea.x, cropArea.y, threshold)) {
          dragHandle = 'tl';
        } else if (isNear(x, y, cropArea.x + cropArea.width, cropArea.y, threshold)) {
          dragHandle = 'tr';
        } else if (isNear(x, y, cropArea.x, cropArea.y + cropArea.height, threshold)) {
          dragHandle = 'bl';
        } else if (isNear(x, y, cropArea.x + cropArea.width, cropArea.y + cropArea.height, threshold)) {
          dragHandle = 'br';
        } else if (x > cropArea.x && x < cropArea.x + cropArea.width &&
                   y > cropArea.y && y < cropArea.y + cropArea.height) {
          dragHandle = 'move';
        }
      });
      
      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!dragHandle) return;
        
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        const deltaX = x - startX;
        const deltaY = y - startY;
        
        switch (dragHandle) {
          case 'tl':
            cropArea.x += deltaX;
            cropArea.y += deltaY;
            cropArea.width -= deltaX;
            cropArea.height -= deltaY;
            break;
          case 'tr':
            cropArea.y += deltaY;
            cropArea.width += deltaX;
            cropArea.height -= deltaY;
            break;
          case 'bl':
            cropArea.x += deltaX;
            cropArea.width -= deltaX;
            cropArea.height += deltaY;
            break;
          case 'br':
            cropArea.width += deltaX;
            cropArea.height += deltaY;
            break;
          case 'move':
            cropArea.x += deltaX;
            cropArea.y += deltaY;
            break;
        }
        
        // æœ€å°ã‚µã‚¤ã‚ºåˆ¶é™
        cropArea.width = Math.max(50, cropArea.width);
        cropArea.height = Math.max(50, cropArea.height);
        
        // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
        cropArea.x = Math.max(0, Math.min(cropArea.x, canvas.width - cropArea.width));
        cropArea.y = Math.max(0, Math.min(cropArea.y, canvas.height - cropArea.height));
        
        startX = x;
        startY = y;
        
        needsRedraw = true;
      });
      
      canvas.addEventListener('touchend', () => {
        dragHandle = null;
      });
    }
    
    function isNear(x, y, targetX, targetY, threshold) {
      return Math.abs(x - targetX) < threshold && Math.abs(y - targetY) < threshold;
    }
    
    function updateCropHandles() {
      document.getElementById('handle-tl').style.left = cropArea.x + 'px';
      document.getElementById('handle-tl').style.top = cropArea.y + 'px';
      
      document.getElementById('handle-tr').style.left = (cropArea.x + cropArea.width) + 'px';
      document.getElementById('handle-tr').style.top = cropArea.y + 'px';
      
      document.getElementById('handle-bl').style.left = cropArea.x + 'px';
      document.getElementById('handle-bl').style.top = (cropArea.y + cropArea.height) + 'px';
      
      document.getElementById('handle-br').style.left = (cropArea.x + cropArea.width) + 'px';
      document.getElementById('handle-br').style.top = (cropArea.y + cropArea.height) + 'px';
    }
    
    // ========================================
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
    // ========================================
    function startAnimationLoop() {
      function animate() {
        if (needsRedraw) {
          redrawPreview();
          needsRedraw = false;
        }
        requestAnimationFrame(animate);
      }
      animate();
    }
    
    // ========================================
    // å›è»¢ãƒœã‚¿ãƒ³
    // ========================================
    document.getElementById('rotate-btn').addEventListener('click', () => {
      rotation = (rotation + 90) % 360;
      needsRedraw = true;
      debugLog(`å›è»¢: ${rotation}åº¦`);
    });
    
    // ========================================
    // æ˜ã‚‹ã•èª¿æ•´
    // ========================================
    document.getElementById('brightness-slider').addEventListener('input', (e) => {
      brightness = parseInt(e.target.value) / 100;
      needsRedraw = true;
      debugLog(`æ˜ã‚‹ã•: ${brightness}`);
    });
    
    // ========================================
    // æ’®ã‚Šç›´ã—ãƒœã‚¿ãƒ³
    // ========================================
    document.getElementById('retake-btn').addEventListener('click', () => {
      rotation = 0;
      brightness = 1.0;
      document.getElementById('brightness-slider').value = 100;
      showScreen('camera-screen');
      initCamera();
    });
    
    // ========================================
    // é€ä¿¡å‡¦ç†
    // ========================================
    document.getElementById('send-btn').addEventListener('click', async () => {
      try {
        debugLog('é€ä¿¡å‡¦ç†é–‹å§‹...');
        showScreen('processing-screen');
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é–‹å§‹
        updateProgress(10);
        
        // æœ€çµ‚ç”»åƒç”Ÿæˆ
        const finalCanvas = await generateFinalImage();
        updateProgress(30);
        
        // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        const base64Data = await canvasToBase64(finalCanvas);
        const imageSize = Math.round(base64Data.length * 0.75);
        debugLog(`ç”»åƒã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å®Œäº† (${(imageSize / 1024 / 1024).toFixed(2)}MB)`);
        updateProgress(50);
        
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const response = await uploadImage({
          userId,
          displayName,
          image: {
            fileName: `scan_${Date.now()}.jpg`,
            imageData: base64Data,
            imageSize
          }
        });
        
        updateProgress(100);
        
        debugLog('âœ… é€ä¿¡æˆåŠŸ');
        
        // å®Œäº†ç”»é¢è¡¨ç¤º
        setTimeout(() => {
          showScreen('complete-screen');
        }, 500);
        
      } catch (error) {
        debugLog(`âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        showError('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', error.message);
      }
    });
    
    // ========================================
    // æœ€çµ‚ç”»åƒç”Ÿæˆ
    // ========================================
    async function generateFinalImage() {
      const canvas = document.getElementById('preview-canvas');
      const finalCanvas = document.createElement('canvas');
      
      // ãƒˆãƒªãƒŸãƒ³ã‚°é©ç”¨
      finalCanvas.width = cropArea.width;
      finalCanvas.height = cropArea.height;
      
      const ctx = finalCanvas.getContext('2d');
      ctx.filter = `brightness(${brightness})`;
      
      // å›è»¢è€ƒæ…®ã—ã¦æç”»
      ctx.save();
      ctx.translate(finalCanvas.width / 2, finalCanvas.height / 2);
      ctx.rotate(rotation * Math.PI / 180);
      
      const scale = Math.min(
        canvas.width / originalCanvas.width,
        canvas.height / originalCanvas.height
      );
      
      // ãƒˆãƒªãƒŸãƒ³ã‚°é ˜åŸŸã®ã¿æŠ½å‡º
      const srcX = (cropArea.x - (canvas.width - originalCanvas.width * scale) / 2) / scale;
      const srcY = (cropArea.y - (canvas.height - originalCanvas.height * scale) / 2) / scale;
      const srcW = cropArea.width / scale;
      const srcH = cropArea.height / scale;
      
      ctx.drawImage(
        originalCanvas,
        srcX, srcY, srcW, srcH,
        -cropArea.width / 2, -cropArea.height / 2,
        cropArea.width, cropArea.height
      );
      
      ctx.restore();
      
      return finalCanvas;
    }
    
    // ========================================
    // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    // ========================================
    function canvasToBase64(canvas, quality = 0.9) {
      return new Promise((resolve, reject) => {
        canvas.toBlob((blob) => {
          if (!blob) {
            reject(new Error('Blobç”Ÿæˆå¤±æ•—'));
            return;
          }
          
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
          };
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      });
    }
    
    // ========================================
    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    // ========================================
    async function uploadImage(data) {
      const response = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      return await response.json();
    }
    
    // ========================================
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
    // ========================================
    function updateProgress(percent) {
      document.getElementById('progress-fill').style.width = percent + '%';
    }
    
    // ========================================
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    // ========================================
    function showError(title, detail) {
      document.getElementById('error-title').textContent = title;
      document.getElementById('error-detail').textContent = detail;
      showScreen('error-screen');
    }
    
    document.getElementById('retry-btn').addEventListener('click', () => {
      showScreen('camera-screen');
      initCamera();
    });
    
    // ========================================
    // LINEã«æˆ»ã‚‹
    // ========================================
    document.getElementById('back-to-line-btn').addEventListener('click', () => {
      closeLiff();
    });
    
    function closeLiff() {
      if (liff.isInClient()) {
        liff.closeWindow();
      } else {
        window.close();
      }
    }
    
    // ========================================
    // åˆæœŸåŒ–
    // ========================================
    window.addEventListener('DOMContentLoaded', () => {
      initBackgroundAnimation();
      initLiff();
    });
  </script>
</body>
</html>